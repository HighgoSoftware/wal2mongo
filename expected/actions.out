\set VERBOSITY terse
-- predictability
SET synchronous_commit = on;
SELECT 'init' FROM pg_create_logical_replication_slot('regression_slot', 'wal2mongo');
 ?column? 
----------
 init
(1 row)

-- actions
CREATE TABLE testing (a integer primary key);
INSERT INTO testing (a) VALUES(200);
UPDATE actions SET a = 500 WHERE a = 200;
ERROR:  relation "actions" does not exist at character 8
DELETE FROM actions WHERE a = 500;
ERROR:  relation "actions" does not exist at character 13
TRUNCATE TABLE actions;
ERROR:  relation "actions" does not exist
-- peek changes according to action configuration
SELECT data FROM pg_logical_slot_peek_changes('regression_slot', NULL, NULL, 'actions', 'insert');
               data                
-----------------------------------
 db.testing.insertOne( { a:200 } )
(1 row)

SELECT data FROM pg_logical_slot_peek_changes('regression_slot', NULL, NULL, 'actions', 'update');
               data                
-----------------------------------
 db.testing.insertOne( { a:200 } )
(1 row)

SELECT data FROM pg_logical_slot_peek_changes('regression_slot', NULL, NULL, 'actions', 'delete');
               data                
-----------------------------------
 db.testing.insertOne( { a:200 } )
(1 row)

SELECT data FROM pg_logical_slot_peek_changes('regression_slot', NULL, NULL, 'actions', 'truncate');
               data                
-----------------------------------
 db.testing.insertOne( { a:200 } )
(1 row)

SELECT data FROM pg_logical_slot_peek_changes('regression_slot', NULL, NULL, 'actions', 'insert, update, delete, truncate');
               data                
-----------------------------------
 db.testing.insertOne( { a:200 } )
(1 row)

-- peek changes with default action configuraiton
SELECT data FROM pg_logical_slot_peek_changes('regression_slot', NULL, NULL);
               data                
-----------------------------------
 db.testing.insertOne( { a:200 } )
(1 row)

-- peek changes with invalid actions
SELECT data FROM pg_logical_slot_peek_changes('regression_slot', NULL, NULL, 'actions', 'insert, xxx, delete, xxx');
ERROR:  could not parse value "xxx" for parameter "actions"
SELECT 'end' FROM pg_drop_replication_slot('regression_slot');
 ?column? 
----------
 end
(1 row)

